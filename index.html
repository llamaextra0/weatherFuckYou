<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="Access-Control-Allow-Origin" content="*">
  <meta http-equiv="Content-Type" content="application/json">
</head>
<body>
<script>
// Read city from URL hash â†’ e.g. #Hong Kong  or #London,UK  or #Tokyo
let p = decodeURIComponent(window.location.hash.substring(1)) || "Hong Kong";

const KEY = "143454aa39bbe3442a890cdbf3f9db36";

Promise.all([
  fetch(`https://api.openweathermap.org/data/2.5/weather?q=${p}&units=metric&appid=${KEY}`).then(r=>r.json()),
  fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${p}&units=metric&appid=${KEY}`).then(r=>r.json())
])
.then(([now, forecast]) => {
  const city = forecast.city;
  const list = forecast.list;

  const today = new Date().toISOString().slice(0,10);
  const time = t => new Date(t*1000).toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});

  const days = {};
  list.forEach(x => {
    const d = x.dt_txt.split(' ')[0];
    if (!days[d]) days[d] = [];
    days[d].push(x);
  });

  const next3days = Object.keys(days).filter(d => d >= today).slice(0,3);

  const cleanForecast = next3days.map(date => {
    const items = days[date];
    const day   = items.find(x => x.dt_txt.includes("12:00")) || items[3];
    const night = items.find(x => x.dt_txt.includes("00:00") || x.dt_txt.includes("03:00")) || items[0];
    return {
      date: date,
      day_temp: Math.round(day.main.temp),
      night_temp: Math.round(night.main.temp),
      description: day.weather[0].description,
      icon: day.weather[0].icon
    };
  });

  const result = {
    city: city.name,
    country: city.country,
    current: {
      temp: Math.round(now.main.temp),
      feels_like: Math.round(now.main.feels_like),
      description: now.weather[0].description,
      icon: now.weather[0].icon
    },
    sunrise: time(city.sunrise),
    sunset: time(city.sunset),
    forecast: cleanForecast
  };

  document.open();
  document.write(JSON.stringify(result, null, 2));
  document.close();
})
.catch(() => {
  document.open();
  document.write(JSON.stringify({error:"City not found or API error"}, null, 2));
  document.close();
});
</script>
</body>
</html>