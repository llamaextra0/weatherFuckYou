<!DOCTYPE html>
<head>
  <meta http-equiv="Access-Control-Allow-Origin" content="*">
  <meta http-equiv="Content-Type" content="application/json">
</head>
<body>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const city = decodeURIComponent(location.hash.substring(1)) || "Hong Kong";
    const key = "143454aa39bbe3442a890cdbf3f9db36";

    const [cur, fore] = await Promise.all([
      fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&units=metric&appid=${key}`).then(r => r.json()),
      fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(city)}&units=metric&appid=${key}`).then(r => r.json())
    ]);

    if (cur.cod !== 200 || fore.cod !== "200") throw new Error("City not found");

    const list = fore.list;
    const today = new Date().toISOString().slice(0, 10);
    const time = t => new Date(t * 1000).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

    const days = {};
    list.forEach(x => {
      const d = x.dt_txt.split(' ')[0];
      if (!days[d]) days[d] = [];
      days[d].push(x);
    });

    const forecast = Object.keys(days)
      .filter(d => d >= today)
      .slice(0, 3)
      .map(date => {
        const items = days[date];
        const day = items.find(x => x.dt_txt.includes("12:00")) || items[3];
        const night = items.find(x => x.dt_txt.includes("00:00") || x.dt_txt.includes("03:00")) || items[0];
        return {
          date,
          day_temp: Math.round(day.main.temp),
          night_temp: Math.round(night.main.temp),
          description: day.weather[0].description,
          icon: day.weather[0].icon
        };
      });

    const result = {
      city: fore.city.name,
      country: fore.city.country,
      current: {
        temp: Math.round(cur.main.temp),
        feels_like: Math.round(cur.main.feels_like),
        description: cur.weather[0].description,
        icon: cur.weather[0].icon
      },
      sunrise: time(fore.city.sunrise),
      sunset: time(fore.city.sunset),
      forecast
    };

    // Overwrite entire document with pure JSON (no HTML)
    document.open();
    document.write(`<pre>${JSON.stringify(result, null, 2)}</pre>`);
    document.close();
  } catch (err) {
    document.open();
    document.write(`<pre>${JSON.stringify({ error: err.message }, null, 2)}</pre>`);
    document.close();
  }
});
</script>
<noscript>
  {"error": "JavaScript required for API"}
</noscript>
</body>
</html>